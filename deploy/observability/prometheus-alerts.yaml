apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hypertuna-gateway-alerts
  labels:
    app: hypertuna
spec:
  groups:
    - name: hypertuna-gateway
      rules:
        - alert: GatewayFallbackWriteWithoutLease
          expr: rate(gateway_relay_fallback_writes_total{result="readonly"}[5m]) > 0
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Gateway fallback write rejected (missing lease)"
            description: "{{ $labels.relay }} has served replica writes without an active escrow lease for >2m."
        - alert: GatewayLeaseExpiringSoon
          expr: gateway_escrow_lease_time_to_expiry_seconds > 0 and gateway_escrow_lease_time_to_expiry_seconds < 60
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Gateway lease will expire in <60s"
            description: "{{ $labels.relay }} lease expires in {{ $value | humanizeDuration }}."
        - alert: EscrowPolicyRejectionSpike
          expr: rate(escrow_policy_rejections_total[5m]) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Escrow policy rejections exceed threshold"
            description: "Escrow service rejected unlocks {{ $value | printf "%.2f" }} times/sec over the last 5 minutes."
