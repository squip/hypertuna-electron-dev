version: '3.9'

services:
  proxy:
    image: traefik:v3.0
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-lets:/letsencrypt
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "300", "1"]
    volumes:
      - redis-data:/data
    restart: unless-stopped

  public-gateway:
    build:
      context: ..
      dockerfile: public-gateway/Dockerfile
    environment:
      GATEWAY_PUBLIC_URL: https://${GATEWAY_HOST}
      GATEWAY_REGISTRATION_SECRET: ${GATEWAY_REGISTRATION_SECRET}
      GATEWAY_DISCOVERY_ENABLED: "true"
      GATEWAY_DISCOVERY_DISPLAY_NAME: "Hypertuna.com Public Gateway"
      GATEWAY_DISCOVERY_REGION: "us-west"
      GATEWAY_REGISTRATION_REDIS: redis://redis:6379
      GATEWAY_REGISTRATION_REDIS_PREFIX: "public-gateway:${GATEWAY_HOST}:"
      GATEWAY_DEFAULT_TOKEN_TTL: 3600
      STORAGE_DIR: /data

      # Relay host + dispatcher
      GATEWAY_FEATURE_HYPERBEE_RELAY: "true"
      GATEWAY_RELAY_STORAGE: /data/gateway-relay
      GATEWAY_RELAY_NAMESPACE: ${GATEWAY_RELAY_NAMESPACE}
      GATEWAY_RELAY_REPLICATION_TOPIC: ${GATEWAY_RELAY_REPLICATION_TOPIC}
      GATEWAY_RELAY_ADMIN_PUBLIC_KEY: ${GATEWAY_RELAY_ADMIN_PUBLIC_KEY}
      GATEWAY_RELAY_ADMIN_SECRET_KEY: ${GATEWAY_RELAY_ADMIN_SECRET_KEY}
      GATEWAY_FEATURE_RELAY_DISPATCHER: ${GATEWAY_FEATURE_RELAY_DISPATCHER:-false}
      GATEWAY_FEATURE_RELAY_TOKEN_ENFORCEMENT: ${GATEWAY_FEATURE_RELAY_TOKEN_ENFORCEMENT:-true}
      GATEWAY_DISPATCHER_MAX_CONCURRENT: ${GATEWAY_DISPATCHER_MAX_CONCURRENT:-3}
      GATEWAY_DISPATCHER_INFLIGHT_WEIGHT: ${GATEWAY_DISPATCHER_INFLIGHT_WEIGHT:-25}
      GATEWAY_DISPATCHER_LATENCY_WEIGHT: ${GATEWAY_DISPATCHER_LATENCY_WEIGHT:-1}
      GATEWAY_DISPATCHER_FAILURE_WEIGHT: ${GATEWAY_DISPATCHER_FAILURE_WEIGHT:-500}
      GATEWAY_DISPATCHER_REASSIGN_LAG: ${GATEWAY_DISPATCHER_REASSIGN_LAG:-500}
      GATEWAY_DISPATCHER_CIRCUIT_BREAKER_THRESHOLD: ${GATEWAY_DISPATCHER_CIRCUIT_BREAKER_THRESHOLD:-5}
      GATEWAY_DISPATCHER_CIRCUIT_BREAKER_TIMEOUT_MS: ${GATEWAY_DISPATCHER_CIRCUIT_BREAKER_TIMEOUT_MS:-60000}

      # Blind peer
      GATEWAY_BLINDPEER_ENABLED: ${GATEWAY_BLINDPEER_ENABLED:-true}
      GATEWAY_BLINDPEER_STORAGE: ${GATEWAY_BLINDPEER_STORAGE:-/data/blind-peer}
      GATEWAY_BLINDPEER_MAX_BYTES: ${GATEWAY_BLINDPEER_MAX_BYTES:-26843545600}
      GATEWAY_BLINDPEER_GC_INTERVAL_MS: ${GATEWAY_BLINDPEER_GC_INTERVAL_MS:-300000}
      GATEWAY_BLINDPEER_TRUSTED_PATH: ${GATEWAY_BLINDPEER_TRUSTED_PATH:-/data/blind-peer/trusted-peers.json}

      # Metrics
      GATEWAY_METRICS_ENABLED: ${GATEWAY_METRICS_ENABLED:-true}

      # Public web serve path (baked into image)
      GATEWAY_PUBLIC_WEB_ENABLED: "true"
      GATEWAY_PUBLIC_WEB_DIST: /opt/hypertuna/public-web/dist
      GATEWAY_PUBLIC_WEB_BASEPATH: /public
      
    depends_on:
      - redis
    volumes:
      - public-gateway-data:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.gateway.rule=Host(`${GATEWAY_HOST}`)
      - traefik.http.routers.gateway.entrypoints=websecure
      - traefik.http.routers.gateway.tls=true
      - traefik.http.routers.gateway.tls.certresolver=le
      - traefik.http.services.gateway.loadbalancer.server.port=4430
    restart: unless-stopped

volumes:
  traefik-lets:
  redis-data:
  public-gateway-data:
